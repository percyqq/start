https://www.jianshu.com/p/69f481a07899


如何保证消息的有序性      有序性分：全局有序和部分有序。

全局有序
    如果要保证消息的全局有序，首先只能由一个生产者往Topic发送消息，并且一个Topic内部只能有一个队列（分区）。
    消费者也必须是单线程消费这个队列。这样的消息就是全局有序的！

    不过一般情况下我们都不需要全局有序，即使是同步MySQL Binlog也只需要保证单表消息有序即可。

部分有序
    因此绝大部分的有序需求是部分有序，部分有序我们就可以将Topic内部划分成我们需要的队列数，把消息通过特定的策略发往固定的队列中，
    然后每个队列对应一个单线程处理的消费者。这样即完成了部分有序的需求，又可以通过队列数量的并发来提高消息处理效率。


图中我画了多个生产者，一个生产者也可以，只要同类消息发往指定的队列即可。


如果处理消息堆积
    消息的堆积往往是因为生产者的生产速度与消费者的消费速度不匹配。
    有可能是因为消息消费失败反复重试造成的，也有可能就是消费者消费能力弱，渐渐地消息就积压了。

因此我们需要先定位消费慢的原因，如果是bug则处理 bug，
    如果是因为本身消费能力较弱，我们可以优化下消费逻辑，
    比如之前是一条一条消息消费处理的，这次我们批量处理，比如数据库的插入，一条一条插和批量插效率是不一样的。

假如逻辑我们已经都优化了，但还是慢，那就得考虑水平扩容了，
    增加Topic的队列数和消费者数量，注意队列数一定要增加，不然新增加的消费者是没东西消费的。
    一个Topic中，一个队列只会分配给一个消费者。

当然你消费者内部是单线程还是多线程消费那看具体场景。
    不过要注意上面提高的消息丢失的问题，如果你是将接受到的消息写入内存队列之后，然后就返回响应给Broker，
    然后多线程向内存队列消费消息，假设此时消费者宕机了，内存队列里面还未消费的消息也就丢了。
